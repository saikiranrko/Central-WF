name: Tag Protection

on:
  workflow_dispatch:
    inputs:
      repository:
        description: 'Target repository (format: owner/repo)'
        required: true
        type: string
      environment:
        description: 'Environment to apply protection'
        required: true
        type: string
      tag_pattern:
        description: 'Tag pattern (regex)'
        required: true
        type: string
  push:
    tags:
      - '*'

jobs:
  check-tag:
    # Use the input environment or fall back to repository variable
    environment: ${{ github.event.inputs.environment || vars.TAG_PROTECTION_ENV }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Check Repository
        run: |
          # Use input repository or fall back to repository variable
          TARGET_REPO="${{ github.event.inputs.repository || vars.PROTECTED_REPOSITORY }}"
          if [ "$TARGET_REPO" != "${{ github.repository }}" ]; then
            echo "Tag protection not configured for this repository"
            exit 0
          fi

      - name: Check Tag Creator
        run: |
          # Get the user who created the tag
          TAG_CREATOR=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/git/${{ github.sha }}" \
            | jq -r '.author.name')
          
          # Get allowed users from repository variable (comma-separated list)
          ALLOWED_USERS_LIST="${{ vars.ALLOWED_TAG_CREATORS }}"
          # Convert comma-separated list to JSON array
          ALLOWED_USERS=$(echo "$ALLOWED_USERS_LIST" | tr ',' '\n' | jq -R . | jq -s .)
          
          # Check if the tag creator is in the allowed list
          if echo "$ALLOWED_USERS" | jq -e --arg USER "$TAG_CREATOR" '. | index($USER)'; then
            echo "Tag created by authorized user: $TAG_CREATOR"
          else
            echo "Unauthorized tag creation by: $TAG_CREATOR"
            # Delete the unauthorized tag
            git push origin :refs/tags/${{ github.ref_name }}
            exit 1
          fi

      - name: Validate Tag Format
        run: |
          # Use input pattern or fall back to repository variable
          TAG_PATTERN="${{ github.event.inputs.tag_pattern || vars.TAG_PATTERN }}"
          # If still not set, use default pattern
          if [ -z "$TAG_PATTERN" ]; then
            TAG_PATTERN='^(v[0-9]+\.[0-9]+\.[0-9]+|release-[0-9]+\.[0-9]+\.[0-9]+)$'
          fi
          
          if [[ ${{ github.ref_name }} =~ $TAG_PATTERN ]]; then
            echo "Tag format is valid: ${{ github.ref_name }}"
          else
            echo "Invalid tag format: ${{ github.ref_name }}"
            git push origin :refs/tags/${{ github.ref_name }}
            exit 1
          fi

      - name: Protect Tag
        run: |
          # Make the tag immutable using the REST API
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/tags/${{ github.ref_name }}/protection" \
            -d '{"enabled": true}'
