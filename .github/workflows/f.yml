name: Deploy Tag Rule

on:
  workflow_dispatch:
    inputs:
      repo_name:
        description: 'The name of the repository'
        required: true
        default: saikiranrko/abc
      tag_pattern:
        description: 'The tag pattern (ref type)'
        required: true
        default: 'v*'  # Default pattern can be all tags starting with "v"
      environment:
        description: 'The environment to deploy the tag'
        required: true
        default: 'production'

jobs:
  add_deployment_rule:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up GitHub CLI
        uses: cli/cli@v2

      - name: Create Deployment Rule for Tag
        run: |
          echo "Creating deployment rule for tag..."
          TAG_PATTERN="${{ github.event.inputs.tag_pattern }}"  # Dynamic tag pattern
          ENVIRONMENT="${{ github.event.inputs.environment }}"  # Dynamic environment
          REPO_NAME="${{ github.event.inputs.repo_name }}"  # Dynamic repo name
          
          # Use GitHub CLI to create a deployment rule
          gh api --method POST "/repos/${REPO_NAME}/environments/${ENVIRONMENT}/deployment-branches-and-tags" \
            -F ref_type="tag" \
            -F name_pattern="${TAG_PATTERN}" \
            --header "Accept: application/vnd.github+json"
        env:
          PERSONAL_ACCESS_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

      - name: Confirm deployment rule
        run: echo "Deployment rule for tag pattern '${TAG_PATTERN}' has been successfully added to environment '${ENVIRONMENT}'!"
