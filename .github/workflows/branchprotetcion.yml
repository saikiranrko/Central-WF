name: Add Branch Protection for Pattern

on:
  workflow_dispatch:
    inputs:
      repo:
        description: "Repository name (owner/repo)"
        required: true
      branch_pattern:
        description: "Branch pattern to apply protection (e.g., release/*)"
        required: true

jobs:
  set-branch-protection:
    runs-on: ubuntu-latest
    steps:
      - name: Apply Branch Protection for Pattern
        env:
          AUTH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          # Parse inputs
          owner=$(echo "${{ github.event.inputs.repo }}" | cut -d'/' -f1)
          repo=$(echo "${{ github.event.inputs.repo }}" | cut -d'/' -f2)
          branch_pattern="${{ github.event.inputs.branch_pattern }}"

          # Define branch protection rules
          echo "Creating branch protection rules for branch pattern '$branch_pattern' in repo $owner/$repo..."

          curl -X POST -H "Authorization: Bearer $AUTH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/$owner/$repo/branch_protection_rules \
            -d '{
              "pattern": "'"$branch_pattern"'",
              "required_status_checks": {
                "strict": true,
                "contexts": []
              },
              "enforce_admins": true,
              "required_pull_request_reviews": {
                "dismiss_stale_reviews": true,
                "require_code_owner_reviews": true,
                "required_approving_review_count": 2
              },
              "restrictions": null,
              "allow_force_pushes": false,
              "allow_deletions": false
            }'

          echo "Branch protection rules applied for branch pattern '$branch_pattern' in repo $owner/$repo."
