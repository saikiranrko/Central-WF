name: Add Protection and Deploy

on:
  workflow_dispatch:
    inputs:
      repo_name:
        description: 'Repository name (e.g., owner/repo)'
        required: true
      pattern:
        description: 'Branch or tag pattern to protect (e.g., v* or main)'
        required: true
      type:
        description: 'Type of protection (branch or tag)'
        required: true
        type: choice
        options:
          - branch
          - tag
      environment:
        description: 'Environment name for deployment'
        required: true

jobs:
  add_protection:
    runs-on: ubuntu-latest

    steps:
      - name: Set up job
        id: setup
        run: echo "Starting protection configuration"

      - name: Add protection
        env:
          GITHUB_TOKEN: ${{ secrets.PAT }}
        run: |
          set -e  # Exit immediately if any command fails

          # Input variables
          REPO_NAME="${{ github.event.inputs.repo_name }}"
          PATTERN="${{ github.event.inputs.pattern }}"
          TYPE="${{ github.event.inputs.type }}"
          ENVIRONMENT="${{ github.event.inputs.environment }}"

          # GitHub API URLs
          API_URL="https://api.github.com/repos/${REPO_NAME}/environments/${ENVIRONMENT}/deployment-branch-policies"

          echo "üîç Inputs: Repository=${REPO_NAME}, Pattern=${PATTERN}, Type=${TYPE}, Environment=${ENVIRONMENT}"

          # Check if the branch or tag pattern already exists
          EXISTING_PATTERNS=$(curl -s \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            $API_URL | jq -r '.branch_policies[]?.name, .tag_policies[]?.name // empty')

          if echo "$EXISTING_PATTERNS" | grep -q "^${PATTERN}$"; then
            echo "‚ö†Ô∏è The pattern '${PATTERN}' already exists for this environment. No action needed."
            exit 0
          fi

          # Conditional API call for branch or tag protection
          if [ "$TYPE" = "branch" ]; then
            echo "üöÄ Adding branch protection for pattern: $PATTERN"
            RESPONSE=$(curl -s -w "%{http_code}" -o response.json \
              -X POST \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              $API_URL \
              -d "{
                    \"name\": \"${PATTERN}\"
                  }")
            if [ "$RESPONSE" -eq 200 ]; then
              echo "‚úÖ Successfully added branch protection for pattern: $PATTERN"
            else
              echo "‚ùå Failed to add branch protection. HTTP Status: $RESPONSE"
              echo "Response body: $(cat response.json)"
              exit 1
            fi
          elif [ "$TYPE" = "tag" ]; then
            echo "üöÄ Adding tag protection for pattern: $PATTERN"
            RESPONSE=$(curl -s -w "%{http_code}" -o response.json \
              -X POST \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              $API_URL \
              -d "{
                    \"name\": \"${PATTERN}\",
                    \"type\": \"tag\"
                  }")
            if [ "$RESPONSE" -eq 200 ]; then
              echo "‚úÖ Successfully added tag protection for pattern: $PATTERN"
            else
              echo "‚ùå Failed to add tag protection. HTTP Status: $RESPONSE"
              echo "Response body: $(cat response.json)"
              exit 1
            fi
          else
            echo "‚ùå Invalid type specified: $TYPE. Use 'branch' or 'tag'."
            exit 1
          fi

      - name: Confirmation
        run: echo "üéâ Protection has been successfully configured for the repository."
